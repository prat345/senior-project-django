{% extends "base.html" %}

{% block title %}
    <title>Incident Query</title>
    <style>
        th, td{
        border: 5px solid rgb(237, 236, 236);
        border-collapse: collapse;
        text-align: center;
        font-weight: normal;
        }
        th{
        font-size: 1.5rem;
        }
        .block{
            box-shadow: 3px 3px 5px silver;
        }
        .label-table{
            overflow-x: scroll;
        }
        /* video */
        .block-vid > iframe{
            border-radius: 10px 0 0 10px;
        }
        .block-text {
            padding-top: 10px;
            padding-left: 25px;
        }
        ul.incident-text{
            list-style: none;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            padding: 0;
            margin: 0;
        }
        /* label inside vid block */
        ul.incident-text > li{
            margin-right: 1em;
            margin-bottom: 0.2em;
        }
        ul.incident-text > li:last-child {
            margin-bottom: 10px;
        }
        ul.incident-text > li:last-child .btn-label {
            background-color: #dddddd;
            padding: 2px 7px;
            color: #808080;
            border: 1px solid #e2e2e2;
            border-radius: 7px;
            display: inline-block;
            margin: 2px 2px;
        }
        .offcanvas{
            width:40% !important;
        }  
        label span {
        display: inline-block;
        padding: 3px 10px;
        margin: 5px 0px;
        border-radius: 8px;
        border: 1px solid #e2e2e2;
        color: #808080;
        background-color: #dddddd;
        }
        .label:checked + span{
        background-color: var(--green);
        color: rgb(255, 255, 255);
        font-style: bold;
        }
        .label:hover + span{
        background-color: var(--green);
        transition-duration: 0.5s;
        color: white;
        }

        /* vid-block 100% width */
        @media (max-width:992px){
            ul.incident-text{
                flex-direction: row;
            }
            .block-vid > iframe{
                border-radius: 10px 10px 0 0;
            }
            .offcanvas{
                width:100% !important;
            }  
        }

        @media (max-width:576px){
            .block-text{
                padding: 5px 20px;
            }
            ul.incident-text > li:not(:last-child){
                display: none;
            }
            *{
                font-size: 0.8rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
        <div class="container-lg" >
            <h1>Incident Query</h1>
            <!-- messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success" role="alert">
                        {{message}}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Offcanvas -->          
            <div 
                class="offcanvas offcanvas-start"  
                data-bs-scroll="true" 
                data-bs-backdrop="true" 
                tabindex="-1" id="offcanvas" aria-labelledby="offcanvasLabel">
                <div class="offcanvas-header">
                    <h4 class="offcanvas-title">Labels</h4>
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <form action="" method="POST">
                        {% csrf_token %}
                        <div class="label-table">
                            <!-- Top level -->
                            <div class="mb-2">
                                <h5>Factor</h5>
                                <div>
                                {% if 'External' in selected %}
                                    <label>
                                        <input class="label" type="checkbox" name="label" value="External" onclick="recordLabel(this.value)" checked>
                                        <span>External</span>
                                    </label>
                                {% else %}
                                    <label>
                                        <input class="label" type="checkbox" name="label" value="External" onclick="recordLabel(this.value)">
                                        <span>External</span>
                                    </label>
                                {% endif %}

                                {% if 'Internal' in selected %}
                                    <label>
                                        <input class="label" type="checkbox" name="label" value="Internal" onclick="recordLabel(this.value)" checked>
                                        <span>Internal</span>
                                    </label>
                                {% else %}
                                    <label>
                                        <input class="label" type="checkbox" name="label" value="Internal" onclick="recordLabel(this.value)">
                                        <span>Internal</span>
                                    </label>
                                {% endif %}
                                </div>
                            </div>

                            {% for topic,arr in labels.items %}
                            <div class="mb-2">
                                <h5>{{topic}}</h5>
                                <div>
                                <!-- 3rd level -->
                                {% for label in arr %} 
                                    {% if label in selected %}
                                        <label>
                                            <input class="label" type="checkbox" name="label" value="{{label}}"
                                                onclick="recordLabel(this.value)" checked>
                                                <span>{{label}}</span>
                                        </label>
                                    {% else %}
                                        <label>
                                            <input class="label" type="checkbox" name="label" value="{{label}}" onclick="recordLabel(this.value)">
                                            <span>{{label}}</span>
                                        </label>
                                    {% endif %}
                                {% endfor %}
                                </div>
                            </div>
                            {% endfor %}

                            <div class="mb-2">
                                <h5>No label</h5>
                                <div>
                                    {% if "" in selected %}
                                    <label>
                                        <input class="label" type="checkbox" name="label" value="" onclick="recordLabel(this.value)" checked>
                                        <span>No Label</span>
                                    </label>
                                    {% else %}
                                    <label>
                                        <input class="label" type="checkbox" name="label" value="" onclick="recordLabel(this.value)">
                                        <span>No Label</span>
                                    </label>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div>
                                <span>Operation :&nbsp;</span>
                                <!-- default AND -->
                                {% if operation == 'OR' %}
                                    <input class="form-check-input" type="radio" id="and" name="operation"
                                            value="AND" onclick="recordOperation(this.value)">
                                    <label for="and">And&nbsp;</label>
            
                                    <input class="form-check-input" type="radio" id="or" name="operation"
                                            value="OR" onclick="recordOperation(this.value)" checked>
                                    <label for="and">Or</label>
                                {% else %} 
                                    <input class="form-check-input" type="radio" id="and" name="operation"
                                            value="AND" onclick="recordOperation(this.value)" checked>
                                    <label for="and">And&nbsp;</label>
            
                                    <input class="form-check-input" type="radio" id="or" name="operation"
                                            value="OR" onclick="recordOperation(this.value)">
                                    <label for="and">Or</label>
                                {% endif %}
                            </div>
                            <!-- SUBMIT -->
                            <div style="margin-top: 5px; margin-bottom: 20px; margin-left: 5x;">
                                <!-- <button type="submit">Submit</button>  -->
                                <button type="button" class="btn btn-primary" onclick ="changeUrl()">Submit</button> 
                                <a href="/incident" class="btn btn-primary">Clear</a>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
              
            <div class="containter-fluid">
                <!-- Label Table -->
                <!-- <form action="" method="POST">
                    {% csrf_token %}
                    <div class="label-table">
                        <table class="table table-light" border="1" cellpadding="10">
                            <thead>
                                <th colspan="3">
                                    {% if 'External' in selected %}
                                        <label>
                                            <input class="label" type="checkbox" name="label" value="External" onclick="recordLabel(this.value)" checked>
                                            <span style="padding-left: 50px; padding-right: 50px;">External</span>
                                        </label>
                                    {% else %}
                                        <label>
                                            <input class="label" type="checkbox" name="label" value="External" onclick="recordLabel(this.value)">
                                            <span style="padding-left: 50px; padding-right: 50px;">External</span>
                                        </label>
                                    {% endif %}
                                </th>
                                <th colspan="2">
                                    {% if 'Internal' in selected %}
                                        <label>
                                            <input class="label" type="checkbox" name="label" value="Internal" onclick="recordLabel(this.value)" checked>
                                            <span style="padding-left: 50px; padding-right: 50px;">Internal</span>
                                        </label>
                                    {% else %}
                                        <label>
                                            <input class="label" type="checkbox" name="label" value="Internal" onclick="recordLabel(this.value)">
                                            <span style="padding-left: 50px; padding-right: 50px;">Internal</span>
                                        </label>
                                    {% endif %}
                                </th>
                            </thead>
                            <tbody  align="left" valign="top">
                                <tr> 
                                    {% for topic,arr in labels.items %}
                                        <td class="sub-topic">
                                            {% if topic in selected %}
                                                <label>
                                                    <input class="label" type="checkbox" name="label" value="{{topic}}" onclick="recordLabel(this.value)" checked>
                                                    <span>{{topic}}</span>
                                                </label>
                                            {% else %}
                                                <label>
                                                    <input class="label" type="checkbox" name="label" value="{{topic}}" onclick="recordLabel(this.value)">
                                                    <span>{{topic}}</span>
                                                </label>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    {% for topic,arr in labels.items %}
                                        <td class="sub-topic-2">
                                        {% for label in arr %}
                                            {% if label in selected %}
                                                <label>
                                                    <input class="label" type="checkbox" name="label" value="{{label}}"
                                                     onclick="recordLabel(this.value)" checked>
                                                     <span>{{label}}</span>
                                                </label>
                                            {% else %}
                                                <label>
                                                    <input class="label" type="checkbox" name="label" value="{{label}}" onclick="recordLabel(this.value)">
                                                    <span>{{label}}</span>
                                                </label>
                                            {% endif %}
                                        {% endfor %}
                                        </td>
                                    {% endfor %}
                                </tr> 
                                <tr>
                                    <td colspan="5">
                                        {% if "" in selected %}
                                        <label>
                                            <input class="label" type="checkbox" name="label" value="" onclick="recordLabel(this.value)" checked>
                                            <span style="padding-left: 100px; padding-right: 100px;">No Label</span>
                                        </label>
                                        {% else %}
                                        <label>
                                            <input class="label" type="checkbox" name="label" value="" onclick="recordLabel(this.value)">
                                            <span style="padding-left: 100px; padding-right: 100px;">No Label</span>
                                        </label>
                                        {% endif %}
                                    </td>
                                </tr>  
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="container-xl">
                        <div style="margin: 5px 0; margin-left: 5px;">
                            <span>Operation :&nbsp;</span>
                            {% if operation == 'OR' %}
                                <input class="form-check-input" type="radio" id="and" name="operation"
                                        value="AND" onclick="recordOperation(this.value)">
                                <label for="and">And&nbsp;</label>
        
                                <input class="form-check-input" type="radio" id="or" name="operation"
                                        value="OR" onclick="recordOperation(this.value)" checked>
                                <label for="and">Or</label>
                            {% else %} 
                                <input class="form-check-input" type="radio" id="and" name="operation"
                                        value="AND" onclick="recordOperation(this.value)" checked>
                                <label for="and">And&nbsp;</label>
        
                                <input class="form-check-input" type="radio" id="or" name="operation"
                                        value="OR" onclick="recordOperation(this.value)">
                                <label for="and">Or</label>
                            {% endif %}
                        </div>

                        <div style="margin-top: 5px; margin-bottom: 20px; margin-left: 5x;">
                            <button type="button" class="btn btn-primary" onclick ="changeUrl()">Submit</button> 
                            <a href="/incident" class="btn btn-secondary" class="button">Clear</a>
                        </div>
                    </div>
                </form> -->

                <!-- VIDEO -->
                <div class="container-fluid p-0">
                    <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvas" aria-controls="offcanvasExample">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        Filter
                    </button>
                    <div class="mb-2 d-flex flex-wrap pe-3">
                        <div class="me-2">Selected({{ operation }}): [ {{ selected|join:', ' }} ]</div>
                        <div>{{ query|length }} results </div>
                    </div>
                    
                    <!-- <p>{{ query }}</p> -->
                    {% for incident in query_p %}
                        <!-- <p>{{ incident.url }}</p> -->
                        <!-- {% for k,v in incident.items %}
                        <p>{{ k }}{{ v }}</p>
                        {% endfor %} --> 
                        <div class="block" id="block-{{ forloop.counter }}">
                            <div class="row">
                                <!-- VIDEO -->
                                <div class="col-12 col-lg-8 block-vid" id="vid-{{ forloop.counter }}" style="padding: 0;">
                                    <script>
                                        showVid('{{ incident.url }}', 'vid-{{ forloop.counter }}')
                                        function showVid(url, id){
                                            url = url.split('/view?usp=drivesdk')[0] + '/preview';
                                            e = document.getElementById(id)
                                            // e.style.backgroundColor = 'rgb(5, 217, 5)';
                                            let vid = document.createElement('iframe');
                                            vid.setAttribute('class', 'vid-frame');
                                            vid.src = url;
                                            vid.width = '100%';
                                            vid.style.aspectRatio = 16/9;
                                            vid.style.display = 'block';
                                            // vid.style.borderRadius = '10px'
                                            e.appendChild(vid);
                                        }
                                    </script>
                                </div>
        
                                <div class="col-12 col-lg-4 block-text">
                                    <ul class="incident-text">
                                        <li><span class="topic">Stamp:</span> <span class="value">{{ incident.stamp }}</span></li>
                                        <li><span class="topic">Testdrive:</span> <span class="value">{{ incident.testdrive }}</span></li>
                                        <li><span class="topic">Vehicle:</span> <span class="value">{{ incident.vehicle }}</span> </li>
                                        <li><span class="topic">Location:</span> <span class="value">{{ incident.location }}</span></li>
                                        <li><span class="topic">Date:</span> <span class="value">{{ incident.date }}</span></li>
                                        <li><span class="topic">Time:</span> <span class="value">{{ incident.time }}</span></li>
                                        <li><span class="topic">Labels:</span> 
                                            <!-- <span class="value">{{ incident.tags }}</span> -->
                                            {% for label in incident.tags %}
                                                <span class="btn-label">{{ label }}</span>
                                            {% endfor %}
                                        </li>
                                    </ul>
                                    <div class="btn-container mb-2">
                                        <a href="/edit/{{incident.stamp}}" class="btn btn-warning" id="edit-button">
                                            <i class="fa-solid fa-pen"></i>
                                            edit</a>
                                        <a href="/delete/{{incident.stamp}}" class="btn btn-danger" id="delete-button"
                                            onclick="return confirm('Confirm deletion')">
                                            <i class="fa-solid fa-trash"></i>
                                            delete</a>
                                    </div>
                                </div>
                            </div>
        
                            <!-- <div id="video"></div> -->
                        </div>
                    {% endfor %}
                </div>

    
                <br>
                <!-- pagination -->
                <nav aria-label="...">
                    <ul class="pagination justify-content-center">
                    {% if query_p.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?q1={{ operation }}&q2={{ selected|join:'_' }}&page=1" aria-label="First">
                        <span aria-hidden="false">&laquo;First</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disable">
                        <a class="page-link">&laquo;First</a>
                    </li>
                    {% endif %}
                    
                    {% if query_p.number|add:'-2' > 1 and query_p.paginator.num_pages < query_p.number|add:'2' %}
                    <li class="page-item"><a class="page-link" 
                        href="?q1={{ operation }}&q2={{ selected|join:'_' }}&page={{ query_p.number|add:'-2' }}"> &hellip; </a></li>
                    {% endif %}

                    {% for i in query_p.paginator.page_range %}
                        {% if i == query_p.number %}
                        <li class="page-item active"><a class="page-link" 
                            href="?q1={{ operation }}&q2={{ selected|join:'_' }}&page={{ i }}">{{ i }}</a></li>
                        {% elif i > query_p.number|add:'-2' and i < query_p.number|add:'2' %}
                        <li class="page-item"><a class="page-link" 
                            href="?q1={{ operation }}&q2={{ selected|join:'_' }}&page={{ i }}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if query_p.paginator.num_pages > query_p.number|add:'3' %}
                    <li class="page-item"><a class="page-link" 
                        href="?q1={{ operation }}&q2={{ selected|join:'_' }}&page={{ query_p.paginator.num_pages|add:'-2' }}">
                        &hellip; </a>
                    </li>
                    <li class="page-item"><a class="page-link" 
                        href="?q1={{ operation }}&q2={{ selected|join:'_' }}&page={{ query_p.paginator.num_pages|add:'-1' }}">
                        {{ query_p.paginator.num_pages|add:'-1' }}</a>
                    </li>
                    {% endif %}
    
                    {% if query_p.has_next %}
                        <li class="page-item"><a class="page-link" 
                            href="?q1={{ operation }}&q2={{ selected|join:'_' }}&page={{ query_p.paginator.num_pages }}" aria-label="Last">
                            <span aria-hidden="false">Last&raquo;</span></a>
                        </li>
                    {% else %}
                        <li class="page-item disable">
                            <a class="page-link">Last&raquo;</a>
                        </li>
                    {% endif %}
                    </ul>
                </nav>
            </div>
        

            <script>
                function showVid(e, url, index){
                    url = url.split('/view?usp=drivesdk')[0] + '/preview';
                    e.style.backgroundColor = 'rgb(5, 217, 5)';
                    let vid = document.createElement('iframe');
                    vid.src = url
                    e.appendChild(vid);
                }
                function changeUrl(){
                    operation = document.querySelector('.form-check-input:checked').value;
                    let selected = document.querySelectorAll('.label:checked'); // return node list
                    selected = Array.prototype.slice.call(selected);
                    let newSelected = selected.map(item => { return item.value });
                    // for (let i of selected) {
                    //     console.log(i.value);
                    //     if (!labels.includes(String(i))){
                    //         labels.push(i.value);
                    //     }
                    // }
                    // labels = [...new Set(labels)];
                    // console.log(selected)
                    // console.log(operation[0].value, selected)
                    document.location.href=`?q1=${ operation }&q2=${ newSelected.join('_') }&page=1`;
                    // document.location.href="/about";
                }
                let labels = [], operation = '';
                function recordLabel(label){
                    console.log(label);
                }
                function recordOperation(opt){
                    console.log(opt);
                }
            </script>

        </div>
{% endblock %}